<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu Extractor - Assign Addons</title>

  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="icon" href="./img/favicon.ico" sizes="any">
  <script src="./config.js"></script>

  <style>
    :root {
      --accent: #ea4e59;
      --accent-hover: #d9444f;
      --bg-light: #f4f7fa;
      --card-bg: #ffffff;
      --text-dark: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --field-bg: #f8fafc;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      --shadow-hover: 0 12px 28px rgba(0, 0, 0, 0.06);
      --radius-card: 24px;
      --radius-row: 16px;
      --radius-input: 10px;
      --danger: #ef4444;
      --ok: #16a34a;
      --pink-soft: #fef2f2;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      padding: 20px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .card {
      width: 100%;
      max-width: 1600px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-card);
      padding: 0;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      height: 90vh;
      max-height: 90vh;
    }

    .header-section {
      padding: 30px 40px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    .brand {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 14px;
    }

    .brand-logo {
      height: 50px;
      width: auto;
      max-width: 150px;
      object-fit: contain;
    }

    h2 { margin: 0; font-size: 22px; }

    .main-container {
      display: flex;
      flex: 1;
      min-height: 0;
      gap: 0;
      overflow: hidden;
    }

    /* LEFT PANEL - ITEMS & CATEGORIES */
    .left-panel {
      flex: 1;
      padding: 25px 30px;
      overflow-y: auto;
      border-right: 1px solid var(--border);
      background: #fafafa;
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-height: 0;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .category-selector {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .category-selector-label {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    select {
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--field-bg);
      font-family: inherit;
      font-size: 13px;
      color: var(--text-dark);
      cursor: pointer;
      outline: none;
      transition: all 0.2s;
    }

    select:hover { border-color: var(--accent); background: #fff; }
    select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(234, 78, 89, 0.1); }

    .items-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .items-header {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .items-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .item-drop-zone {
      padding: 14px;
      background: #fff;
      border: 2px dashed var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: auto;
    }

    .item-drop-zone:hover { border-color: var(--accent); background: rgba(234, 78, 89, 0.03); }
    .item-drop-zone.drag-over { border-color: var(--accent); background: rgba(234, 78, 89, 0.08); box-shadow: inset 0 0 8px rgba(234, 78, 89, 0.15); }

    .item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .item-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .item-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-dark);
      flex: 1;
    }

    .item-addons-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-left: 28px;
    }

    .addon-entry {
      background: var(--field-bg);
      padding: 8px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .addon-entry-header {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .addon-entry-name {
      font-weight: 600;
      color: var(--accent);
      flex: 1;
      font-size: 12px;
    }

    .addon-remove-btn {
      background: transparent;
      border: none;
      color: var(--accent);
      width: 16px;
      height: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .addon-remove-btn:hover { color: #e74c3c; }

    .addon-size-prices {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 10px;
    }

    .addon-size-price-row {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
    }

    .addon-size-price-row label {
      min-width: 50px;
      font-weight: 600;
    }

    .addon-size-price-input {
      width: 50px !important;
      padding: 3px 4px !important;
      font-size: 10px !important;
      height: 20px !important;
      background: #fff !important;
      border: 1px solid var(--border) !important;
      color: var(--text-dark) !important;
      border-radius: 3px !important;
    }

    .empty-items {
      padding: 30px 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* RIGHT PANEL - DRAGGABLE ADDONS */
    .right-panel {
      flex: 1;
      padding: 25px 30px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: #fafafa;
      border-left: 1px solid var(--border);
      min-height: 0;
    }

    .addons-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .addons-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      gap: 10px;
    }

    .apply-all-addons-btn {
      background: var(--accent);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.2s;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .apply-all-addons-btn:hover { background: var(--accent-hover); }
    .apply-all-addons-btn:disabled { background: #cbd5e1; cursor: not-allowed; }

    .addons-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .addon-item {
      padding: 12px 14px;
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: move;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dark);
      transition: all 0.2s ease;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .addon-item:hover { border-color: var(--accent); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .addon-item.dragging { opacity: 0.5; border-color: var(--accent); }

    .addon-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .addon-item-name {
      color: var(--accent);
      font-weight: 700;
      flex: 1;
    }

    .addon-item-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .apply-all-btn, .remove-all-btn, .delete-addon-btn {
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.2s;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .apply-all-btn { background: var(--accent); }
    .apply-all-btn:hover { background: var(--accent-hover); }

    .remove-all-btn { background: #f39c12; }
    .remove-all-btn:hover { background: #e67e22; }

    .delete-addon-btn {
      background: #e74c3c;
      width: 28px;
      height: 28px;
      padding: 0;
      font-size: 16px;
    }
    .delete-addon-btn:hover { background: #c0392b; }

    .addon-item.new-addon {
      background: rgba(234, 78, 89, 0.05);
      border-color: var(--accent);
    }

    .empty-addons {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    .add-addon-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: #fff;
      border: 2px dashed var(--accent);
      border-radius: 10px;
    }

    .add-addon-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .add-addon-form input {
      padding: 8px 10px !important;
      font-size: 13px !important;
      border: 1px solid var(--border) !important;
      background: var(--field-bg) !important;
      border-radius: 6px !important;
    }

    .add-addon-buttons {
      display: flex;
      gap: 8px;
    }

    .add-addon-buttons button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      transition: 0.2s;
    }

    .add-addon-buttons .confirm {
      background: var(--accent);
      color: white;
    }
    .add-addon-buttons .confirm:hover { background: var(--accent-hover); }

    .add-addon-buttons .cancel {
      background: var(--field-bg);
      color: var(--text-dark);
    }

    .btn-add {
      background: #fef2f2;
      border: none;
      color: var(--accent);
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
      width: 100%;
      transition: 0.2s;
    }
    .btn-add:hover { background: var(--accent); color: white; }

    .footer-actions {
      display: flex;
      gap: 10px;
      padding: 15px 40px;
      border-top: 1px solid var(--border);
      background: #fafafa;
      flex-shrink: 0;
    }

    button.main {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      font-size: 14px;
      transition: 0.3s;
    }

    .primary { background: var(--accent); color: white; }
    .primary:hover { background: var(--accent-hover); }
    .primary:disabled { background: #cbd5e1; cursor: not-allowed; }
    .pink-ghost { background: #fef2f2; color: var(--accent); border: 1px solid var(--accent); }

    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="header-section">
      <a href="https://admin.orderart.com.au/" target="_blank" rel="noopener noreferrer" class="brand" aria-label="Go to OrderArt Admin">
        <img src="./img/logo.jpg" alt="OrderArt" class="brand-logo" onerror="this.style.display='none'" />
      </a>
      <h2>Assign Addons to Items</h2>
    </div>

    <div class="main-container">
      <!-- LEFT PANEL - ITEMS & CATEGORIES -->
      <div class="left-panel">
        <div class="category-selector">
          <label class="category-selector-label">Select Category</label>
          <select id="category-select"></select>
        </div>
        
        <div class="items-section">
          <div class="items-header">Items in Category</div>
          <div id="items-container" class="items-container"></div>
        </div>
      </div>

      <!-- RIGHT PANEL - DRAGGABLE ADDONS -->
      <div class="right-panel">
        <div class="addons-section-header">
          <label class="panel-title">Available Addons</label>
          <button class="apply-all-addons-btn" id="apply-all-addons-btn">Apply All</button>
        </div>
        <div class="addons-section">
          <div id="addons-list" class="addons-list"></div>
        </div>
      </div>
    </div>

    <div class="footer-actions">
      <button class="main pink-ghost" id="backBtn">Back</button>
      <button class="main primary" id="nextBtn">Finish & Submit</button>
    </div>
  </div>

  <script>
    const API_BASE = (window.APP_CONFIG?.API_BASE || "").replace(/\/$/, "");

    const dom = {
      addonsList: document.getElementById("addons-list"),
      categorySelect: document.getElementById("category-select"),
      itemsContainer: document.getElementById("items-container"),
      nextBtn: document.getElementById("nextBtn"),
      backBtn: document.getElementById("backBtn"),
      applyAllAddonsBtn: document.getElementById("apply-all-addons-btn"),
    };

    const storage = {
      jobId: localStorage.getItem("job_id"),
      phase2Result: localStorage.getItem("phase2_result"),
      phase4Result: localStorage.getItem("phase4_result"),
    };

    if (!storage.jobId) {
      window.location.href = "./index.html";
    }

    let isDirty = false;
    function markDirty() { isDirty = true; }

    let menuDataPhase2 = null;
    let menuDataPhase4 = null;
    let menuData = null;
    let categoryName = null;
    let draggedAddon = null;
    let addingAddonInCategory = false;
    let newAddonsByCategory = {};
    let expandedItems = {};

    async function parseError(response) {
      try {
        const text = await response.text();
        try {
          const j = JSON.parse(text);
          return typeof j?.detail === "string" ? j.detail : JSON.stringify(j?.detail || j);
        } catch {
          return text;
        }
      } catch {
        return "Unknown error occurred";
      }
    }

    function escText(v) {
      return String(v ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function escAttr(v) {
      return String(v ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll('"', "&quot;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function loadPhase4Data() {
      if (storage.phase2Result) {
        const parsed = JSON.parse(storage.phase2Result);
        menuDataPhase2 = parsed?.data ? parsed.data : parsed;
      }
      
      if (storage.phase4Result) {
        const parsed = JSON.parse(storage.phase4Result);
        menuDataPhase4 = parsed?.data ? parsed.data : parsed;
      }
      
      menuData = menuDataPhase2;
      
      if (!menuData) {
        console.error("No phase2 data found in localStorage. Redirecting to bases.html");
        window.location.href = "./bases.html";
      }
      console.log("Phase 2 Data Loaded (items):", menuDataPhase2);
      console.log("Phase 4 Data Loaded (addons):", menuDataPhase4);
    }

    function getCategories() {
      const cats = new Set();
      (menuData?.pages || []).forEach((page) => {
        (page?.categories || []).forEach((cat) => {
          cats.add(cat.name_raw || cat.name);
        });
      });
      return Array.from(cats).sort();
    }

    function getItemsByCategory(category) {
      const items = [];
      (menuData?.pages || []).forEach((page) => {
        (page?.categories || []).forEach((cat) => {
          if (cat.name_raw === category || cat.name === category) {
            if (cat.category_items?.length > 0) {
              cat.category_items.forEach((group) => {
                (group.items || []).forEach((item) => {
                  items.push({ item, category: cat.name_raw || cat.name });
                });
              });
            }
            if (cat.subcategory_items?.length > 0) {
              cat.subcategory_items.forEach((subcat) => {
                (subcat.items || []).forEach((item) => {
                  items.push({ item, category: cat.name_raw || cat.name });
                });
              });
            }
            if (items.length === 0 && cat.items?.length > 0) {
              cat.items.forEach((item) => {
                items.push({ item, category: cat.name_raw || cat.name });
              });
            }
          }
        });
      });
      return items;
    }

    function getAddonsForCategory(category) {
      const addonMap = {};
      (menuDataPhase4?.pages || []).forEach((page) => {
        (page?.categories || []).forEach((cat) => {
          if (cat.name_raw === category || cat.name === category) {
            (cat.items_addons || []).forEach((item) => {
              (item.addons || []).forEach((addon) => {
                const addonName = addon.name_raw || "Unknown";
                if (!addonMap[addonName]) {
                  addonMap[addonName] = {
                    name_raw: addonName,
                    price: addon.price || { amount: 0, currency: "USD" },
                    price_by_variation: addon.price_by_variation || [],
                  };
                }
              });
            });
            (cat.subcategory_items || []).forEach((subcat) => {
              (subcat.items_addons || []).forEach((item) => {
                (item.addons || []).forEach((addon) => {
                  const addonName = addon.name_raw || "Unknown";
                  if (!addonMap[addonName]) {
                    addonMap[addonName] = {
                      name_raw: addonName,
                      price: addon.price || { amount: 0, currency: "USD" },
                      price_by_variation: addon.price_by_variation || [],
                    };
                  }
                });
              });
            });
          }
        });
      });
      return Object.values(addonMap).sort((a, b) => a.name_raw.localeCompare(b.name_raw));
    }

    function getNewAddons(category) {
      return newAddonsByCategory[category] || [];
    }

    function getAddonPriceForSize(addon, sizeName) {
      if (!addon.price_by_variation || addon.price_by_variation.length === 0) {
        return addon.price?.amount || 0;
      }
      const sizePrice = addon.price_by_variation.find((pv) => pv.variation_name === sizeName);
      return sizePrice?.price?.amount || addon.price?.amount || 0;
    }

    function renderCategories() {
      const cats = getCategories();
      dom.categorySelect.innerHTML = '<option value="">Choose a category...</option>';
      cats.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = escText(cat);
        dom.categorySelect.appendChild(opt);
      });
    }

    function renderAddons() {
      dom.addonsList.innerHTML = "";
      
      if (!categoryName) {
        const msg = document.createElement("div");
        msg.className = "empty-addons";
        msg.textContent = "Select a category to see addons";
        dom.addonsList.appendChild(msg);
        return;
      }

      const addons = getAddonsForCategory(categoryName);
      const newAddons = getNewAddons(categoryName);
      
      if (addons.length > 0) {
        addons.forEach((addon) => {
          const addonEl = document.createElement("div");
          addonEl.className = "addon-item";
          addonEl.draggable = true;
          
          const header = document.createElement("div");
          header.className = "addon-item-header";
          
          const nameSpan = document.createElement("span");
          nameSpan.className = "addon-item-name";
          nameSpan.textContent = escText(addon.name_raw);
          header.appendChild(nameSpan);
          
          const actions = document.createElement("div");
          actions.className = "addon-item-actions";
          
          const applyBtn = document.createElement("button");
          applyBtn.className = "apply-all-btn";
          applyBtn.textContent = "Apply All";
          applyBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const items = getItemsByCategory(categoryName);
            items.forEach(({ item }) => {
              if (!item.addons) item.addons = [];
              if (!item.addons.some((a) => a.name_raw === addon.name_raw)) {
                item.addons.push({
                  name_raw: addon.name_raw,
                  price: addon.price || { amount: 0, currency: "USD" },
                  price_by_variation: addon.price_by_variation || [],
                });
              }
            });
            markDirty();
            renderAddons();
            renderItems();
          };
          actions.appendChild(applyBtn);
          
          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-all-btn";
          removeBtn.textContent = "Remove All";
          removeBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const items = getItemsByCategory(categoryName);
            items.forEach(({ item }) => {
              if (item.addons) {
                item.addons = item.addons.filter((a) => a.name_raw !== addon.name_raw);
              }
            });
            if (!newAddonsByCategory[categoryName]) newAddonsByCategory[categoryName] = [];
            if (!newAddonsByCategory[categoryName].some((a) => a.name_raw === addon.name_raw)) {
              newAddonsByCategory[categoryName].push(addon);
            }
            markDirty();
            renderAddons();
            renderItems();
          };
          actions.appendChild(removeBtn);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-addon-btn";
          deleteBtn.textContent = "×";
          deleteBtn.type = "button";
          deleteBtn.title = "Delete addon";
          deleteBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const items = getItemsByCategory(categoryName);
            items.forEach(({ item }) => {
              if (item.addons) {
                item.addons = item.addons.filter((a) => a.name_raw !== addon.name_raw);
              }
            });
            markDirty();
            renderAddons();
            renderItems();
          };
          actions.appendChild(deleteBtn);
          
          header.appendChild(actions);
          addonEl.appendChild(header);
          
          addonEl.addEventListener("dragstart", (e) => {
            draggedAddon = addon;
            addonEl.classList.add("dragging");
          });
          
          addonEl.addEventListener("dragend", () => {
            addonEl.classList.remove("dragging");
            draggedAddon = null;
          });
          
          dom.addonsList.appendChild(addonEl);
        });
      }

      if (newAddons.length > 0) {
        newAddons.forEach((addon, idx) => {
          const addonEl = document.createElement("div");
          addonEl.className = "addon-item new-addon";
          addonEl.draggable = true;
          
          const header = document.createElement("div");
          header.className = "addon-item-header";
          
          const nameSpan = document.createElement("span");
          nameSpan.className = "addon-item-name";
          nameSpan.textContent = escText(addon.name_raw);
          header.appendChild(nameSpan);
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-addon-btn";
          deleteBtn.textContent = "×";
          deleteBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            newAddonsByCategory[categoryName].splice(idx, 1);
            markDirty();
            renderAddons();
          };
          header.appendChild(deleteBtn);
          
          addonEl.appendChild(header);
          
          addonEl.addEventListener("dragstart", (e) => {
            draggedAddon = addon;
            addonEl.classList.add("dragging");
          });
          
          addonEl.addEventListener("dragend", () => {
            addonEl.classList.remove("dragging");
            draggedAddon = null;
          });
          
          dom.addonsList.appendChild(addonEl);
        });
      }

      if (addons.length === 0 && newAddons.length === 0) {
        const msg = document.createElement("div");
        msg.className = "empty-addons";
        msg.textContent = "No addons available";
        dom.addonsList.appendChild(msg);
      }

      const addSection = document.createElement("div");
      addSection.className = "add-addon-section";
      
      if (!addingAddonInCategory) {
        const addBtn = document.createElement("button");
        addBtn.className = "btn-add";
        addBtn.textContent = "+ Add New Addon";
        addBtn.onclick = () => {
          addingAddonInCategory = true;
          renderAddons();
        };
        addSection.appendChild(addBtn);
      } else {
        const form = document.createElement("div");
        form.className = "add-addon-form";
        
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "Addon name...";
        form.appendChild(input);
        
        const buttons = document.createElement("div");
        buttons.className = "add-addon-buttons";
        
        const confirmBtn = document.createElement("button");
        confirmBtn.className = "confirm";
        confirmBtn.textContent = "Add";
        confirmBtn.onclick = () => {
          if (input.value.trim()) {
            if (!newAddonsByCategory[categoryName]) newAddonsByCategory[categoryName] = [];
            newAddonsByCategory[categoryName].push({
              name_raw: input.value.trim(),
              price: { amount: 0, currency: "USD" },
              price_by_variation: [],
            });
            markDirty();
          }
          addingAddonInCategory = false;
          renderAddons();
        };
        buttons.appendChild(confirmBtn);
        
        const cancelBtn = document.createElement("button");
        cancelBtn.className = "cancel";
        cancelBtn.textContent = "Cancel";
        cancelBtn.onclick = () => {
          addingAddonInCategory = false;
          renderAddons();
        };
        buttons.appendChild(cancelBtn);
        
        form.appendChild(buttons);
        addSection.appendChild(form);
        
        setTimeout(() => input.focus(), 0);
      }
      
      dom.addonsList.appendChild(addSection);
      
      const hasAddons = addons.length > 0;
      const hasNewAddons = newAddons.length > 0;
      const hasItems = getItemsByCategory(categoryName).length > 0;
      dom.applyAllAddonsBtn.disabled = !(hasAddons || hasNewAddons) || !categoryName || !hasItems;
    }

    function toggleItem(itemName) {
      if (expandedItems[itemName]) {
        delete expandedItems[itemName];
      } else {
        expandedItems[itemName] = true;
      }
      renderItems();
    }

    function renderItems() {
      dom.itemsContainer.innerHTML = "";
      
      if (!categoryName) {
        const msg = document.createElement("div");
        msg.className = "empty-items";
        msg.textContent = "Select a category to see items";
        dom.itemsContainer.appendChild(msg);
        return;
      }

      const items = getItemsByCategory(categoryName);

      if (items.length === 0) {
        const msg = document.createElement("div");
        msg.className = "empty-items";
        msg.textContent = "No items in this category";
        dom.itemsContainer.appendChild(msg);
        return;
      }

      items.forEach(({ item, category }) => {
        const dropZone = document.createElement("div");
        dropZone.className = "item-drop-zone";
        dropZone.dataset.itemName = escAttr(item.name_raw || "");

        const header = document.createElement("div");
        header.className = "item-header";
        header.onclick = () => toggleItem(item.name_raw);
        
        const toggle = document.createElement("span");
        toggle.className = "item-toggle";
        toggle.textContent = expandedItems[item.name_raw] ? "−" : "+";
        header.appendChild(toggle);
        
        const nameSpan = document.createElement("span");
        nameSpan.className = "item-name";
        nameSpan.textContent = escText(item.name_raw || "Item");
        header.appendChild(nameSpan);
        
        dropZone.appendChild(header);

        if (expandedItems[item.name_raw] && item.addons && item.addons.length > 0) {
          const addonsSection = document.createElement("div");
          addonsSection.className = "item-addons-section";
          
          item.addons.forEach((addon) => {
            const addonName = addon.name_raw || "Unknown";
            const addonEntry = document.createElement("div");
            addonEntry.className = "addon-entry";
            
            const addonHeader = document.createElement("div");
            addonHeader.className = "addon-entry-header";
            
            const nameSpan = document.createElement("span");
            nameSpan.className = "addon-entry-name";
            nameSpan.textContent = escText(addonName);
            addonHeader.appendChild(nameSpan);
            
            const removeBtn = document.createElement("button");
            removeBtn.className = "addon-remove-btn";
            removeBtn.textContent = "×";
            removeBtn.type = "button";
            removeBtn.onclick = (e) => {
              e.stopPropagation();
              item.addons = (item.addons || []).filter((a) => a.name_raw !== addonName);
              markDirty();
              renderItems();
            };
            addonHeader.appendChild(removeBtn);
            
            addonEntry.appendChild(addonHeader);
            
            const pricesDiv = document.createElement("div");
            pricesDiv.className = "addon-size-prices";
            
            if (item.variations && item.variations.length > 0) {
              // Show price for each size
              item.variations.forEach((variation, vIdx) => {
                const sizeName = variation.size || variation.name_raw || "Unknown";
                const addonPrice = getAddonPriceForSize(addon, sizeName);
                
                const row = document.createElement("div");
                row.className = "addon-size-price-row";
                
                const label = document.createElement("label");
                label.textContent = escText(sizeName) + ":";
                row.appendChild(label);
                
                const input = document.createElement("input");
                input.type = "number";
                input.step = "0.01";
                input.min = "0";
                input.placeholder = "0";
                input.value = addonPrice;
                input.className = "addon-size-price-input";
                input.onchange = () => {
                  actions.updateItemAddonPrice(item.name_raw, addonName, sizeName, input.value);
                };
                row.appendChild(input);
                
                pricesDiv.appendChild(row);
              });
            } else {
              // No sizes - show base price
              const row = document.createElement("div");
              row.className = "addon-size-price-row";
              
              const label = document.createElement("label");
              label.textContent = "Base:";
              row.appendChild(label);
              
              const input = document.createElement("input");
              input.type = "number";
              input.step = "0.01";
              input.min = "0";
              input.placeholder = "0";
              input.value = addon.price?.amount || 0;
              input.className = "addon-size-price-input";
              input.onchange = () => {
                actions.updateItemAddonPrice(item.name_raw, addonName, "Base", input.value);
              };
              row.appendChild(input);
              
              pricesDiv.appendChild(row);
            }
            
            addonEntry.appendChild(pricesDiv);
            
            addonsSection.appendChild(addonEntry);
          });
          
          dropZone.appendChild(addonsSection);
        }

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "copy";
          dropZone.classList.add("drag-over");
        });

        dropZone.addEventListener("dragleave", (e) => {
          if (e.target === dropZone || e.currentTarget === dropZone) {
            dropZone.classList.remove("drag-over");
          }
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("drag-over");
          
          if (draggedAddon) {
            if (!item.addons) item.addons = [];
            if (!item.addons.some((a) => a.name_raw === draggedAddon.name_raw)) {
              item.addons.push({
                name_raw: draggedAddon.name_raw,
                price: draggedAddon.price || { amount: 0, currency: "USD" },
                price_by_variation: draggedAddon.price_by_variation || [],
              });
            }
            markDirty();
            renderItems();
          }
        });

        dom.itemsContainer.appendChild(dropZone);
      });
    }

    dom.categorySelect.addEventListener("change", (e) => {
      categoryName = e.target.value || null;
      addingAddonInCategory = false;
      expandedItems = {};
      renderAddons();
      renderItems();
    });

    dom.applyAllAddonsBtn.addEventListener("click", () => {
      if (!categoryName) return;
      
      const addons = getAddonsForCategory(categoryName);
      const newAddons = getNewAddons(categoryName);
      const items = getItemsByCategory(categoryName);
      
      const allAddons = [...addons];
      newAddons.forEach((newAddon) => {
        allAddons.push(newAddon);
      });
      
      items.forEach(({ item }) => {
        if (!item.addons) item.addons = [];
        allAddons.forEach((addon) => {
          if (!item.addons.some((a) => a.name_raw === addon.name_raw)) {
            item.addons.push({
              name_raw: addon.name_raw,
              price: addon.price || { amount: 0, currency: "USD" },
              price_by_variation: addon.price_by_variation || [],
            });
          }
        });
      });
      
      newAddonsByCategory[categoryName] = [];
      
      markDirty();
      renderAddons();
      renderItems();
    });

    dom.backBtn.addEventListener("click", () => {
      window.location.href = "./bases.html";
    });

    dom.nextBtn.addEventListener("click", async () => {
      dom.nextBtn.disabled = true;
      dom.nextBtn.textContent = "Saving...";

      try {
        if (isDirty) {
          const response = await fetch(`${API_BASE}/api/phase4/${encodeURIComponent(storage.jobId)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              job_id: storage.jobId,
              data: menuData,
            }),
          });

          if (!response.ok) throw new Error(await parseError(response));
          isDirty = false;
        }

        alert("Menu extraction completed successfully!");
        window.location.href = "./index.html";
      } catch (err) {
        alert("Save failed: " + (err?.message || JSON.stringify(err)));
        console.error(err);
        dom.nextBtn.disabled = false;
        dom.nextBtn.textContent = "Finish & Submit";
      }
    });

    const actions = {
      updateItemAddonPrice(itemName, addonName, sizeName, value) {
        const items = getItemsByCategory(categoryName);
        const item = items.find(({ item: i }) => i.name_raw === itemName)?.item;
        if (item && item.addons) {
          const addon = item.addons.find((a) => a.name_raw === addonName);
          if (addon) {
            if (!addon.price_by_variation) addon.price_by_variation = [];
            let sizePrice = addon.price_by_variation.find((pv) => pv.variation_name === sizeName);
            if (!sizePrice) {
              sizePrice = { variation_name: sizeName, price: { amount: 0, currency: "USD" } };
              addon.price_by_variation.push(sizePrice);
            }
            sizePrice.price.amount = parseFloat(value) || 0;
          }
        }
        markDirty();
      },
    };

    window.actions = actions;

    (function init() {
      loadPhase4Data();
      renderCategories();
      renderAddons();
      renderItems();
    })();
  </script>
</body>
</html>
